# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# The following lines were added by compinstall

zstyle ':completion:*' completer _expand _complete _ignored _approximate
zstyle ':completion:*' max-errors 1
zstyle :compinstall filename "${HOME}/.zshrc"

autoload -Uz compinit
compinit
# End of lines added by compinstall

# the detailed meaning of the below three variable can be found in `man zshparam`.
export HISTFILE=~/.histfile
export HISTSIZE=1000000   # the number of items for the internal history list
export SAVEHIST=1000000   # maximum number of items for the history file

# The meaning of these options can be found in man page of `zshoptions`.
setopt hist_ignore_all_dups  # do not put duplicated command into history list
setopt hist_save_no_dups  # do not save duplicated command
setopt hist_reduce_blanks  # remove unnecessary blanks
setopt inc_append_history_tIME  # append command to history file immediately after execution
setopt extended_history  # record command start time
setopt interactivecomments  # Allow interactive shells to treat '#' as a comment
setopt no_nomatch  # Allow use of asterisk in commandlines without quoting, e.g. for grep/rg/fd

unsetopt autocd beep
bindkey -v

bindkey "^R" history-incremental-pattern-search-backward

# Start of Powerline10k config
{{ if eq .chezmoi.os "linux" -}}
source /usr/share/zsh-theme-powerlevel10k/powerlevel10k.zsh-theme
{{ else if eq .chezmoi.os "darwin" -}}
source $(brew --prefix)/opt/powerlevel10k/powerlevel10k.zsh-theme
{{- end }}

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -r ~/.p10k.zsh ]] && source ~/.p10k.zsh
# End of Powerline10k config

# Load .zprofile which has paths, fpaths
[[ -r ${HOME}/.zprofile ]] && source ${HOME}/.zprofile

# Load any custom environment variables, including secure ones
[[ -r ${HOME}/.env ]] && source ${HOME}/.env
[[ -r ${HOME}/.env-secure ]] && source ${HOME}/.env-secure

# 1Password completion
command -v op >/dev/null 2>&1 && eval "$(op completion zsh)" && compdef _op op

# gopass completion
command -v gopass >/dev/null 2>&1 && eval `gopass completion zsh`

# github-cli completion
command -v gh >/dev/null 2>&1 && eval `gh completion -s zsh`

# chezmoi completion
command -v chezmoi >/dev/null 2>&1 && eval `chezmoi completion zsh`

# twilio completion
command -v twilio >/dev/null 2>&1 && eval `twilio autocomplete:script zsh`

# GPG Agent (Also for ssh-agent provided by GPG)
[[ -r ${HOME}/.gnupg/shell-config.sh ]] && source ${HOME}/.gnupg/shell-config.sh

{{- if eq .chezmoi.os "linux" }}
# Wayland/Wayland
if loginctl show-session $(loginctl show-user ${USER} -p Display --value) -p Type --value | grep -q wayland ; then
        export XDG_SESSION_TYPE=wayland
        export GDK_BACKEND=wayland
else
        export XDG_SESSION_TYPE=X11
        export GDK_BACKEND=X11
fi
{{- end }}

# fzf integration
[[ -r ${HOME}/.config/fzf/fzf.zsh ]] && source ${HOME}/.config/fzf/fzf.zsh

# Pet
[[ -r ${HOME}/.config/pet/pet.zsh ]] && source ${HOME}/.config/pet/pet.zsh

{{ if eq .chezmoi.os "darwin" -}}
# iTerm shell integration
[[ -r ${HOME}/.iterm2_shell_integration.zsh ]] && source ${HOME}/.iterm2_shell_integration.zsh
{{ "" }}
{{ end -}}

# Podman/Docker
podman_sock="${HOME}/.local/share/containers/podman/machine/podman-machine-default/podman.sock"
if [[ -S "$podman_sock" ]]; then
        export DOCKER_HOST="unix://${podman_sock}"
        alias docker="podman"
        alias docker-compose="podman-compose"
fi

# Custom aliases
{{- if eq .chezmoi.os "linux" }}
alias ls='ls --color=auto'
{{ else if eq .chezmoi.os "darwin" }}
alias ls='ls -GFh'
{{- end }}
alias grep='grep --color=auto'
alias files='fd -uu -g --type=file ""'
alias terraforming='docker run --rm --name terraforming --volume=${HOME}/.aws:/root/.aws:ro quay.io/dtan4/terraforming:latest terraforming'
alias shellcheck='docker run --rm --name shellcheck --volume=${PWD}:/mnt:ro koalaman/shellcheck:stable'
